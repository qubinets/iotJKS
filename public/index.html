<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonoff Control</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

    <style>
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        .status-online {
            background-color: green;
        }
        .status-offline {
            background-color: red;
        }
    </style>
</head>
<body class="container">
<h1 class="my-4">Sonoff Control</h1>
<button id="getDevicesButton" class="btn btn-primary my-3">Get Devices</button>
<ul id="devicesList" class="list-group mb-4"></ul>
<div id="sensorData" class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">Temperature/Humidity Sensor</h5>
        <p class="card-text">
            <i class="fas fa-thermometer-half"></i> Temperature: <span id="temperature"></span>°C<br>
            <i class="fas fa-tint"></i> Humidity: <span id="humidity"></span>%
        </p>
    </div>
</div>
<div class="container">
<h3> Manual channels control</h3>
<div id="channelButtons" class="d-grid gap-2 d-md-flex justify-content-md-start mb-4">

    <button class="btn btn-outline-success" data-channel="1">Channel 1</button>
    <button class="btn btn-outline-success" data-channel="2">Channel 2</button>
    <button class="btn btn-outline-success" data-channel="3">Channel 3</button>
    <button class="btn btn-outline-success" data-channel="4">Channel 4</button>
</div>
</div>
<input type="color" id="colorPicker" value="#FF0000">
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.0/js/all.min.js" crossorigin="anonymous"></script>
<script>
    const deviceId = '10017b7136'; // Замените на ID вашего устройства
    const sensorDeviceId = 'a480056d1b'; // Замените на ID вашего датчика температуры/влажности
    const lampa = '100123e422';
    const ws = new WebSocket(`ws://${location.host}/websocket`);

    ws.addEventListener('message', (event) => {
        const data = JSON.parse(event.data);
        if (data.deviceid && data.params && data.params.switch) {
            updateDeviceStatus(data.deviceid);
        }
    });

    async function getSensorData() {
        const response = await fetch(`/getSensorData?deviceid=${sensorDeviceId}`);
        const sensorData = await response.json();

        const temperature = sensorData.temperature / 100; // Деление на 100
        const humidity = sensorData.humidity / 100; // Деление на 100

        document.getElementById('temperature').textContent = `${temperature.toFixed(2)}`; // Округление до 2 знаков после запятой
        document.getElementById('humidity').textContent = `${humidity.toFixed(2)}`; // Округление до 2 знаков после запятой
    }

    async function getDevices() {
        const response = await fetch('/getDevices');
        const devices = await response.json();
        const devicesList = document.getElementById('devicesList');
        devicesList.innerHTML = '';

        devices.forEach(device => {
            const li = document.createElement('li');
            li.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');
            const deviceName = document.createElement('span');
            deviceName.textContent = `${device.name} (${device.deviceid})`;
            li.appendChild(deviceName);

            const statusIndicator = document.createElement('span');
            statusIndicator.classList.add('status-indicator');
            statusIndicator.setAttribute('data-deviceid', device.deviceid);
            li.appendChild(statusIndicator);
            devicesList.appendChild(li);
            updateDeviceStatus(device.deviceid);
        });
    }

    async function updateDeviceStatus(deviceId) {
        const response = await fetch(`/getDevice?deviceid=${deviceId}`);
        const device = await response.json();
        const status = device.params.switches[0].switch;

        const statusIndicator = document.querySelector(`.status-indicator[data-deviceid="${deviceId}"]`);
        if (statusIndicator) {
            statusIndicator.textContent = status === 'on' ? 'ON' : 'OFF';
            statusIndicator.classList.toggle('text-success', status === 'on');
            statusIndicator.classList.toggle('text-danger', status !== 'on');
        }
    }

    async function setChannel(channel, state) {
        const response = await fetch(`/setChannel?deviceid=${deviceId}&channel=${channel}&state=${state}`);
        const result = await response.json();
        console.log(result);
    }

    document.getElementById('getDevicesButton').addEventListener('click', () => {
        getDevices();
    });

    document.querySelectorAll('#channelButtons button').forEach(button => {
        button.addEventListener('click', () => {
            const channel = button.getAttribute('data-channel');
            const currentState = button.textContent;
            const newState = currentState === 'ON' ? 'off' : 'on';
            button.textContent = newState === 'on' ? 'ON' : 'OFF';
            button.classList.toggle('btn-outline-success', newState === 'on');
            button.classList.toggle('btn-outline-danger', newState !== 'on');
            setChannel(channel, newState);
        });
    });

    async function getDeviceParameters() {
        const response = await fetch(`/getDevice?deviceid=100123e422`); // Замените на ID вашей лампы
        const deviceParameters = await response.json();
        console.log(deviceParameters);
    }
    async function setSwitchState(deviceId, newState) {
        const response = await fetch('/setSwitchState', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ deviceid: deviceId, state: newState }),
        });
        const result = await response.json();
        if (result.success) {
            console.log('Switch state updated successfully');
        } else {
            console.log('Failed to update switch state');
        }
    }
    async function setColor(deviceId, r, g, b) {
        const response = await fetch('/setColor', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ deviceId, r, g, b }),
        });

        const result = await response.json();
        if (result.success) {
            console.log('Color updated successfully');
        } else {
            console.log('Failed to update color');
        }
    }
    document.getElementById('colorPicker').addEventListener('change', async (event) => {
        const newColor = event.target.value;
        const deviceId = '100123e422'; // замените этот идентификатор на нужный
        const r = parseInt(newColor.slice(1, 3), 16);
        const g = parseInt(newColor.slice(3, 5), 16);
        const b = parseInt(newColor.slice(5, 7), 16);
        await setColor(deviceId, r, g, b);
    });

    getDeviceParameters();
    getSensorData();
    setInterval(getSensorData, 6000);

</script>
</body>
</html>